<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>UScan Pro v25.9 — WORKING</title>
<script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
<style>
  body{font-family:Segoe UI,Arial;background:#0a0a1a;color:#e0e0ff;margin:0;overflow:hidden}
  header{background:#1e1b4b;padding:20px;text-align:center}
  h1{margin:0;font-size:3rem;background:linear-gradient(90deg,#8b5cf6,#00ff88);-webkit-background-clip:text;color:transparent}
  #scanBtn{display:block;margin:40px auto;padding:30px 160px;font-size:3rem;background:#8b5cf6;color:white;border:none;border-radius:50px;cursor:pointer;box-shadow:0 30px 80px rgba(139,92,246,.9)}
  #pasteArea{margin:20px auto;width:90%;max-width:1200px;height:35vh;background:white;color:#000;border:12px solid #8b5cf6;border-radius:50px;padding:50px;font-size:20px;overflow:auto}
  #pasteArea:empty:before{content:"Paste any FCN here";color:#999;font-size:2.5rem;text-align:center;display:block;margin-top:12vh}
  #floatBtn{position:fixed;right:30px;top:50%;transform:translateY(-50%);width:80px;height:80px;background:#8b5cf6;color:white;border-radius:50%;font-size:3rem;cursor:pointer;z-index:9999;box-shadow:0 20px 60px rgba(139,92,246,1)}
  #coPilot{position:fixed;inset:40px;background:#0f0f23;border:14px solid #8b5cf6;border-radius:50px;z-index:99999;display:none;flex-direction:column;box-shadow:0 0 400px rgba(139,92,246,1.5)}
  #coHeader{background:#8b5cf6;color:white;padding:30px;font-size:2.8rem;text-align:center;font-weight:900}
  #chatArea{flex:1;overflow-y:auto;padding:40px;background:#0f0f23}
  .msg{margin:20px 0;padding:25px 35px;border-radius:35px;font-size:2rem;line-height:1.8}
  .grok{background:#1e1b4b;color:#00ff88;border-left:10px solid #00ff88}
  .result{background:#10b981;color:white}
  .error{background:#7f1d1d;color:#ff6b6b}
</style>
</head>
<body>

<header><h1>UScan Pro v25.9</h1></header>
<center><button id="scanBtn">SCAN & EXTRACT</button></center>
<div id="pasteArea" contenteditable="true"></div>
<button id="floatBtn" style="display:none">Right Arrow</button>

<div id="coPilot">
  <div id="coHeader">UScan Co-Pilot</div>
  <div id="chatArea">
    <div class="msg grok">Ready. Click SCAN to launch.</div>
  </div>
</div>

<script type="module">
let pyodide = null;
let engineCode = null;

function log(msg, type="grok") {
  const div = document.createElement("div");
  div.className = "msg " + type;
  div.innerHTML = msg;
  document.getElementById("chatArea").appendChild(div);
  div.scrollIntoView({behavior:"smooth"});
}

async function loadPyodideSafe() {
  if (pyodide) return true;
  log("Loading Pyodide engine (this takes 5-10s first time)...", "grok");
  try {
    pyodide = await loadPyodide({indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.1/full/"});
    log("Pyodide loaded.", "grok");
    await pyodide.loadPackage(["numpy", "pandas", "micropip"]);
    await pyodide.runPythonAsync(`import micropip; await micropip.install('yfinance')`);
    log("yfinance ready.", "grok");
    return true;
  } catch (e) {
    log("Pyodide failed: " + e.message + " — retrying in 5s...", "error");
    setTimeout(loadPyodideSafe, 5000);
    return false;
  }
}

async function loadEngine() {
  if (engineCode) return true;
  log("Fetching engine.py...", "grok");
  const r = await fetch("engine.py?t=" + Date.now());
  if (!r.ok) {
    log("ERROR: engine.py not found! Check GitHub upload.", "error");
    return false;
  }
  engineCode = await r.text();
  log("engine.py loaded.", "grok");
  return true;
}

document.getElementById("scanBtn").onclick = async () => {
  document.getElementById("coPilot").style.display = "flex";
  document.getElementById("floatBtn").style.display = "block";
  document.getElementById("chatArea").innerHTML = "";
  log("Launching 19 KB nuclear Monte Carlo...", "grok");

  const pyOk = await loadPyodideSafe();
  if (!pyOk) return;
  const engOk = await loadEngine();
  if (!engOk) return;

  log("Running 10,000 correlated paths...", "grok");

  try {
    const result = await pyodide.runPythonAsync(engineCode);
    const data = JSON.parse(result);

    log(`
      Expected Return: <b style="color:#00ff88">+${data.er}%</b><br>
      Loss Probability: <b style="color:#ff4444">${data.loss}%</b><br><br>
      <b style="font-size:2.5rem">STRONG BUY — LOAD IT</b>
    `, "result");

    const plot = document.createElement("div");
    plot.style.height = "500px";
    document.getElementById("chatArea").appendChild(plot);

    const s = document.createElement("script");
    s.src = "https://cdn.plot.ly/plotly-2.34.0.min.js";
    s.onload = () => Plotly.newPlot(plot, [{y: data.payoffs, type: "histogram", marker: {color: "#8b5cf6"}}], {
      title: {text: "10,000 Correlated Paths — v25.9", font: {color: "#e0e0ff"}},
      paper_bgcolor: "#0f0f23", plot_bgcolor: "#0f0f23", font: {color: "#e0e0ff"}
    }, {responsive: true});
    document.head.appendChild(s);

  } catch (e) {
    log("Engine failed: " + e.message, "error");
  }
};

document.getElementById("floatBtn").onclick = () => {
  document.getElementById("coPilot").style.display = "flex";
};
</script>
</body>
</html>
