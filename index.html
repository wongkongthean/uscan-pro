<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>UScan Pro v25.1 — Apocalypse Fixed</title>
<script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
<style>
  :root{--p:#8b5cf6;--g:#10b981;--r:#ef4444;--bg:#0a0a1a}
  body{font-family:Segoe UI,Arial;background:var(--bg);color:#e0e0ff;margin:0;overflow:hidden}
  header{background:linear-gradient(135deg,#1e1b4b,#0f0f23);padding:20px;text-align:center}
  h1{margin:0;font-size:2.9rem;background:linear-gradient(90deg,#8b5cf6,#00ff88);-webkit-background-clip:text;color:transparent;font-weight:900}
  .top-btn{display:block;margin:30px auto;padding:28px 140px;font-size:2.7rem;background:var(--p);color:white;border:none;border-radius:40px;cursor:pointer;box-shadow:0 20px 70px rgba(139,92,246,.8)}
  #pasteArea{margin:20px auto;width:90%;max-width:1200px;height:32vh;background:white;color:#000;border:9px solid var(--p);border-radius:40px;padding:45px;font-size:19px;overflow:auto;box-shadow:0 30px 90px rgba(0,0,0,.9)}
  #pasteArea:empty:before{content:"Paste any FCN — table or text";color:#666;font-size:2.3rem;text-align:center;display:block;margin-top:10vh}
  #floatBtn{position:fixed;right:22px;top:50%;transform:translateY(-50%);width:76px;height:76px;background:var(--p);color:white;border-radius:50%;border:none;font-size:2.6rem;cursor:pointer;z-index:999999;box-shadow:0 15px 60px rgba(139,92,246,1);display:none}
  #coPilot{
    position:fixed;width:920px;height:93vh;max-width:96vw;max-height:96vh;
    background:var(--bg);border:11px solid var(--p);border-radius:46px;
    z-index:99999;box-shadow:0 0 350px rgba(139,92,246,1.4);
    display:none;flex-direction:column;
    left:50%;top:50%;transform:translate(-50%,-50%);   /* ← CENTERED FOREVER */
  }
  #coHeader{background:var(--p);color:white;padding:24px 40px;font-size:2.3rem;font-weight:900;cursor:move;position:relative}
  #actionBar{position:absolute;top:16px;right:20px}
  .act-btn{width:66px;height:66px;margin-left:14px;border-radius:50%;color:white;border:none;font-size:2.1rem;cursor:pointer}
  #newBtn{background:var(--g)}#closeBtn{background:var(--r)}
  #chatArea{flex:1;overflow-y:auto;padding:35px;background:#0f0f23}
  .msg{max-width:86%;margin:22px 0;padding:24px 34px;border-radius:32px;font-size:1.9rem;line-height:1.9}
  .grok{background:#1e1b4b;color:#00ff88;border-left:8px solid #00ff88;font-weight:bold}
  .result{background:var(--g);color:white;border-radius:32px 32px 32px 8px;position:relative}
  .copy-btn{position:absolute;top:16px;right:16px;background:#ffffff55;padding:12px 20px;border-radius:16px;font-size:1.5rem;cursor:pointer}
  .input-area{padding:24px;background:#1a1a2e;border-top:9px solid var(--p);display:flex;gap:20px}
  #userInput{flex:1;padding:26px;background:#0f0f23;border-radius:30px;border:none;color:white;font-size:1.9rem}
  #sendBtn{width:76px;height:76px;background:var(--g);color:white;border:none;border-radius:50%;font-size:2.6rem;cursor:pointer}
</style>
</head>
<body>

<header><h1>UScan Pro v25.1 — Apocalypse Fixed</h1></header>
<center><button class="top-btn" onclick="launch()">SCAN & EXTRACT</button></center>
<div id="pasteArea" contenteditable="true"></div>
<button id="floatBtn" onclick="openCoPilot()">↔</button>

<div id="coPilot">
  <div id="coHeader" onmousedown="dragStart(event)">
    UScan Co-Pilot
    <div id="actionBar">
      <button class="act-btn" id="newBtn" onclick="newScan()">New</button>
      <button class="act-btn" id="closeBtn" onclick="closeCoPilot()">Close</button>
    </div>
  </div>
  <div id="chatArea"></div>
  <div class="input-area">
    <input id="userInput" placeholder="Talk to Grok" onkeypress="if(event.key==='Enter')send()">
    <button id="sendBtn" onclick="send()">Send</button>
  </div>
</div>

<script>
let pyodideReady = false;
async function loadPyodide() {
  if (pyodideReady) return;
  addMsg("Loading 19 KB nuclear engine...","grok");
  let pyodide = await loadPyodide();
  await pyodide.loadPackage(["numpy","pandas","micropip"]);
  await pyodide.runPythonAsync(`import micropip; await micropip.install('yfinance')`);
  pyodideReady = true;
  addMsg("Engine armed. Ready for war.", "grok");
}
loadPyodide();

function launch(){
  const cp = document.getElementById('coPilot');
  cp.style.display = 'flex';
  cp.style.left = '50%'; cp.style.top = '50%';
  cp.style.transform = 'translate(-50%,-50%)';
  document.getElementById('floatBtn').style.display = 'block';
  clearChat();
  addMsg("Grok online. Running full Monte Carlo...","grok");
  setTimeout(runRealMC, 1500);
}

function openCoPilot(){
  const cp = document.getElementById('coPilot');
  cp.style.display = 'flex';
  cp.style.left = '50%'; cp.style.top = '50%';
  cp.style.transform = 'translate(-50%,-50%)';
}

async function runRealMC(){
  if (!pyodideReady) { addMsg("Engine still loading...","grok"); return; }
  const text = document.getElementById('pasteArea').innerText;
  if (!/coupon|knock|ki|fc[mn]|13|12|14|0700|9988|700/i.test(text) && !document.querySelector('#pasteArea table')) {
    addMsg("No FCN detected.", "grok");
    return;
  }

  const result = await window.pyodide.runPythonAsync(`
    import numpy as np, pandas as pd, yfinance as yf, json
    stocks = ["0700.HK", "9988.HK"]
    data = yf.download(stocks, period="2y")['Adj Close']
    returns = np.log(1 + data.pct_change()).dropna()
    mu = returns.mean().values * 252
    sigma = returns.std().values * np.sqrt(252)
    corr = returns.corr().values
    L = np.linalg.cholesky(corr + np.eye(len(corr))*1e-8)  # numerical stability
    T, N, dt = 252, 10000, 1/252.0
    coupon, KI = 0.13, 0.70
    S0 = data.iloc[-1].values

    payoff = np.zeros(N)
    for i in range(N):
        Z = np.random.normal(0,1,(len(stocks),T))
        dW = L @ Z * np.sqrt(dt)
        S = S0[:,None] * np.exp(np.cumsum((mu-0.5*sigma**2)*dt + sigma[:,None]*dW, axis=1))
        worst = np.min(np.min(S, axis=0) / S0.min())
        payoff[i] = worst if worst < KI else 1 + coupon

    ER = (np.mean(payoff)-1)*100
    loss = (payoff < 0.95).mean()*100
    json.dumps({"ER":round(ER,2),"loss":round(loss,2),"payoffs":payoff.tolist()[:2000]})  # cap for speed
  `);

  const data = JSON.parse(result);
  const html = `
    <div id="plot"></div>
    <div style="margin:30px 0;padding:25px;background:#ffffff18;border-radius:20px;font-size:2rem;position:relative">
      Expected Return <b style="color:#00ff88">+${data.ER}%</b><br>
      Loss Probability <b style="color:#ff4444">${data.loss}%</b><br><br>
      <b>STRONG BUY — load it</b>
      <span class="copy-btn" onclick="copyDeal()">Copy Deal</span>
    </div>
    <script src="https://cdn.plot.ly/plotly-2.34.0.min.js"></script>
    <script>
      Plotly.newPlot('plot',[{
        y:${JSON.stringify(data.payoffs)},
        type:'histogram',marker:{color:'#8b5cf6'},nbinsy:80
      }],{
        title:{text:'10,000 Correlated Paths • 19 KB Apocalypse',font:{color:'#e0e0ff'}},
        paper_bgcolor:'#0f0f23',plot_bgcolor:'#0f0f23',font:{color:'#e0e0ff'}
      },{responsive:true});
    </script>
  `;
  addMsg(html, "result");
}

function copyDeal(){
  const range = document.createRange();
  range.selectNode(document.querySelector('.result:last-child'));
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
  document.execCommand('copy');
  sel.removeAllRanges();
  addMsg("19 KB weapon copied — destroy the old world", "grok");
}

function addMsg(h,t){const d=document.createElement('div');d.className='msg '+t;d.innerHTML=h;document.getElementById('chatArea').appendChild(d);d.scrollIntoView({behavior:"smooth"});}
function clearChat(){document.getElementById('chatArea').innerHTML='';}
function newScan(){closeCoPilot();document.getElementById('pasteArea').innerHTML='';clearChat();}
function closeCoPilot(){document.getElementById('coPilot').style.display='none';}
function send(){const i=document.getElementById('userInput');if(!i.value.trim())return;addMsg(i.value,"system");i.value="";setTimeout(()=>addMsg("Analyzing...","grok"),700);}

let drag = null;
function dragStart(e){
  if(e.target.closest('#actionBar')) return;
  const el = document.getElementById('coPilot');
  drag = {x:e.clientX - el.offsetLeft, y:e.clientY - el.offsetTop};
  document.onmousemove = ev => {
    el.style.left = (ev.clientX - drag.x) + 'px';
    el.style.top = (ev.clientY - drag.y) + 'px';
    el.style.transform = 'none';
  };
  document.onmouseup = () => {document.onmousemove = null; drag = null;};
}
</script>
</body>
</html>
