<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UScan Pro v30.5-AI-ALPHA</title>
<style>
  :root{--p:#8b5cf6;--g:#10b981;--bg:#000}
  body{font-family:Arial,Helvetica,sans-serif;background:#000;color:#ccc;margin:0;overflow:hidden;font-size:14px;line-height:1.4}
  header{background:#111;padding:12px 20px;text-align:center;border-bottom:2px solid var(--p);position:relative}
  h1{margin:0;font-size:22px;color:#fff}
  .alpha-badge{position:absolute;top:10px;right:15px;background:#000;border:2px solid var(--p);padding:5px 12px;font-size:11px;letter-spacing:1.5px;color:var(--p);font-weight:bold}
  .top-btn{margin:20px auto;padding:14px 40px;font-size:16px;background:var(--p);color:#fff;border:none;border-radius:6px;cursor:pointer;display:block}
  #pasteArea{margin:20px auto;width:94%;height:42vh;background:#111;color:#fff;border:2px solid #333;padding:16px;font-size:13px;overflow:auto;border-radius:6px;box-sizing:border-box}
  #pasteArea:empty:before{content:"Paste Fixed Coupon Note(s)...";color:#555;font-style:italic}
  
  /* Right-edge remote arrow */
  #remoteArrow{position:fixed;right:12px;top:50%;transform:translateY(-50%);width:48px;height:80px;background:var(--p);color:#fff;border-radius:12px 0 0 12px;font-size:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:9999;box-shadow:-4px 0 20px rgba(139,92,246,.6)}
  
  /* Bottom-right future hub */
  #hubOrb{position:fixed;right:20px;bottom:20px;width:64px;height:64px;background:radial-gradient(circle at 30% 30%, #fff, var(--p));color:#000;border-radius:50%;font-size:32px;display:flex;align-items:center;justify-content:center;cursor:move;z-index:9998;box-shadow:0 8px 30px rgba(139,92,246,.8);animation:spin 8s linear infinite}
  @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  
  #coPilot{position:fixed;inset:20px;background:#000;border:3px solid var(--p);border-radius:8px;z-index:99999;display:none;flex-direction:column;box-shadow:0 0 30px rgba(139,92,246,.5);resize:both;overflow:hidden}
  #coHeader{background:var(--p);color:#fff;padding:10px;font-size:16px;text-align:center;cursor:move;font-weight:bold}
  #chatArea{flex:1;overflow-y:auto;padding:16px;background:#111;font-size:13px}
  .msg{margin:12px 0;padding:12px 16px;border-radius:6px}
  .grok{background:#1a1a2e;color:#0f0}
  .result{background:#1a1a2e;color:#ddd;border-left:3px solid #ffb}
  .disclaimer{background:#300;color:#f66;padding:12px;border-radius:6px;margin:16px 0;font-size:12px;text-align:center}
  
  #confirmBox{position:fixed;inset:0;background:#000d;display:none;flex-direction:column;justify-content:center;align-items:center;z-index:999999}
  #confirmInner{background:#111;padding:30px;border-radius:8px;border:3px solid var(--p);width:90%;max-width:760px;max-height:85vh;overflow-y:auto;color:#ddd}
  .btn{padding:10px 24px;margin:8px;font-size:14px;border:none;border-radius:6px;cursor:pointer}
  .yes{background:var(--g);color:#fff}
  .no{background:#444;color:#fff}
  .note-block{background:#1a1a2e;padding:14px;margin:12px 0;border-radius:6px;border-left:4px solid var(--p)}
</style>
</head>
<body>

<header>
  <h1>UScan Pro <span style="color:#888">v30.5-AI-ALPHA</span></h1>
  <div class="alpha-badge">AI-ALPHA</div>
</header>

<center><button class="top-btn" id="scanBtn">ANALYZE NOTES</button></center>
<div id="pasteArea" contenteditable="true"></div>

<div id="remoteArrow" onclick="toggleCoPilot()">→</div>
<div id="hubOrb" onclick="toggleCoPilot()">∞</div>

<div id="coPilot">
  <div id="coHeader" onmousedown="drag(event,'coPilot')">UScan Co-Pilot v30.5-AI-ALPHA</div>
  <div id="chatArea">
    <div class="grok">v30.5-AI-ALPHA stable core ready. Tablet + desktop tested.</div>
    <div class="disclaimer">EDUCATIONAL TOOL • NOT INVESTMENT ADVICE • USER CONFIRMATION REQUIRED</div>
  </div>
</div>

<div id="confirmBox">
  <div id="confirmInner" onmousedown="drag(event,'confirmInner')">
    <h3 style="color:var(--p)">Confirm Analysis</h3>
    <p>Verify parsed notes. Confirmation required before processing.</p>
    <div id="confirmList"></div>
    <div style="text-align:center;margin-top:20px">
      <button class="btn yes" onclick="proceed()">Confirm & Analyze</button>
      <button class="btn no" onclick="cancel()">Cancel</button>
    </div>
  </div>
</div>

<script>
let parsedNotes = [];

function toggleCoPilot(){
  const cp = document.getElementById("coPilot");
  cp.style.display = cp.style.display === "flex" ? "none" : "flex";
}

function rateROI(roi){
  if(roi >= 15) return {text:"Excellent", color:"#0f0"};
  if(roi >= 10) return {text:"Very Attractive", color:"#0f0"};
  if(roi >= 5)  return {text:"Attractive", color:"#8f8"};
  if(roi >= 0)  return {text:"Neutral", color:"#ff8"};
  if(roi >= -10) return {text:"Elevated Risk", color:"#f80"};
  return {text:"Highly Speculative", color:"#f00"};
}

function parseFCNs(text){
  const blocks = text.trim().split(/\n\s*\n/).map(b=>b.trim()).filter(b=>b);
  const notes = [];
  for(let block of blocks){
    const l = block.toLowerCase();
    const n = {underlyings:[], tenor:0, strike:null, ki:null, ko:null, coupon:null, issuer:null};
    if(/tencent|700/.test(l)) n.underlyings.push('0700.HK');
    if(/baba|9988/.test(l)) n.underlyings.push('9988.HK');
    if(/byd|1211/.test(l)) n.underlyings.push('1211.HK');
    if(/geely|175/.test(l)) n.underlyings.push('0175.HK');
    const m = l.match(/(\d+)\s*month/); if(m) n.tenor = parseInt(m[1]);
    if(/strike\s*(\d+\.?\d*)/.test(l)) n.strike = parseFloat(RegExp.$1)/100;
    if(/ki\s*(\d+\.?\d*)/.test(l)) n.ki = parseFloat(RegExp.$1)/100;
    if(/ko\s*(\d+\.?\d*)/.test(l)) n.ko = parseFloat(RegExp.$1)/100;
    if(/coupon.*?(\d+\.?\d*)/.test(l)) n.coupon = parseFloat(RegExp.$1)/100;
    if(/issuer\s+(\w+)/.test(l)) n.issuer = RegExp.$1.toUpperCase();
    if(n.underlyings.length && n.coupon && n.tenor) notes.push(n);
  }
  return notes;
}

function analyze(){
  const text = (document.getElementById("pasteArea").innerText || document.getElementById("pasteArea").textContent).trim();
  if(text.length < 40) return;
  parsedNotes = parseFCNs(text);
  if(parsedNotes.length === 0){
    log("No valid FCN detected. Check format.", "grok");
    return;
  }
  showConfirmation();
}

function showConfirmation(){
  const list = document.getElementById("confirmList");
  list.innerHTML = "";
  parsedNotes.forEach((n,i)=>{
    const roi = n.coupon * (n.tenor/12) * 100;
    const rating = rateROI(roi);
    list.innerHTML += `
      <div class="note-block">
        <b>Note ${i+1}</b>: ${n.underlyings.join(' + ')}<br>
        ${n.tenor} mo | ${(n.coupon*100).toFixed(1)}% p.a. → <span style="color:${rating.color}">${roi.toFixed(2)}% annualized</span><br>
        Strike ${n.strike?(n.strike*100).toFixed(1)+'%':'—'} | KI ${n.ki?(n.ki*100).toFixed(0)+'%':'—'} | KO ${n.ko?(n.ko*100).toFixed(0)+'%':'—'} | Issuer ${n.issuer||'—'}
      </div>`;
  });
  document.getElementById("confirmBox").style.display = "flex";
}

function proceed(){
  document.getElementById("confirmBox").style.display = "none";
  toggleCoPilot();
  document.getElementById("chatArea").innerHTML = "";
  log("Analysis authorized by user.", "grok");
  parsedNotes.forEach((n,i)=>{
    const roi = n.coupon * (n.tenor/12) * 100;
    const rating = rateROI(roi);
    log(`<div class="result"><b>Note ${i+1}</b> — ${n.underlyings.join(' + ')}<br>${n.tenor} months | ${(n.coupon*100).toFixed(1)}% p.a.<br><b style="color:${rating.color}">Yield ${roi.toFixed(2)}% → ${rating.text}</b></div>`);
  });
}

function cancel(){
  document.getElementById("confirmBox").style.display = "none";
  log("Analysis cancelled by user.", "grok");
}

function log(html,type="grok"){
  const d=document.createElement("div"); d.className="msg "+type;
  d.innerHTML=html; document.getElementById("chatArea").appendChild(d);
  d.scrollIntoView();
}

function drag(e, id){
  const el = document.getElementById(id);
  const rect = el.getBoundingClientRect();
  const offsetX = e.clientX - rect.left;
  const offsetY = e.clientY - rect.top;
  const move = (ev) => {
    el.style.left = (ev.clientX - offsetX) + "px";
    el.style.top = (ev.clientY - offsetY) + "px";
    el.style.right = "auto";
    el.style.bottom = "auto";
  };
  document.addEventListener("mousemove", move);
  document.addEventListener("mouseup", () => document.removeEventListener("mousemove", move), {once:true});
  document.addEventListener("touchmove", (ev) => {
    ev.preventDefault();
    move(ev.touches[0]);
  }, {passive:false});
}

// Touch + mouse support
document.getElementById("scanBtn").onclick = analyze;
document.getElementById("pasteArea").addEventListener("paste", () => setTimeout(analyze, 800));
document.getElementById("coHeader").onmousedown = (e) => drag(e, "coPilot");
document.getElementById("confirmInner").onmousedown = (e) => drag(e, "confirmInner");
</script>
</body>
</html>
