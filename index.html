<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>UScan Pro v25.8 — FINAL CLEAN</title>
<script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
<style>
  :root{--p:#8b5cf6;--g:#10b981;--r:#ef4444;--bg:#0a0a1a}
  body{font-family:Segoe UI,Arial;background:var(--bg);color:#e0e0ff;margin:0;overflow:hidden}
  header{background:linear-gradient(135deg,#1e1b4b,#0f0f23);padding:20px;text-align:center}
  h1{margin:0;font-size:2.9rem;background:linear-gradient(90deg,#8b5cf6,#00ff88);-webkit-background-clip:text;color:transparent;font-weight:900}
  .top-btn{display:block;margin:30px auto;padding:28px 140px;font-size:2.7rem;background:var(--p);color:white;border:none;border-radius:40px;cursor:pointer;box-shadow:0 20px 70px rgba(139,92,246,.8)}
  #pasteArea{margin:20px auto;width:90%;max-width:1200px;height:32vh;background:white;color:#000;border:9px solid var(--p);border-radius:40px;padding:45px;font-size:19px;overflow:auto;box-shadow:0 30px 90px rgba(0,0,0,.9)}
  #pasteArea:empty:before{content:"Paste any FCN — table or text";color:#666;font-size:2.3rem;text-align:center;display:block;margin-top:10vh}
  #floatBtn{position:fixed;right:22px;top:50%;transform:translateY(-50%);width:76px;height:76px;background:var(--p);color:white;border-radius:50%;border:none;font-size:2.6rem;cursor:pointer;z-index:999999;box-shadow:0 15px 60px rgba(139,92,246,1);display:none}
  #coPilot{position:fixed;width:920px;height:93vh;max-width:96vw;max-height:96vh;background:var(--bg);border:11px solid var(--p);border-radius:46px;z-index:99999;box-shadow:0 0 350px rgba(139,92,246,1.4);display:none;flex-direction:column;left:50%;top:50%;transform:translate(-50%,-50%)}
  #coHeader{background:var(--p);color:white;padding:24px 40px;font-size:2.3rem;font-weight:900}
  #chatArea{flex:1;overflow-y:auto;padding:35px;background:#0f0f23}
  .msg{max-width:86%;margin:22px 0;padding:24px 34px;border-radius:32px;font-size:1.9rem;line-height:1.9}
  .grok{background:#1e1b4b;color:#00ff88;border-left:8px solid #00ff88;font-weight:bold}
  .result{background:var(--g);color:white}
</style>
</head>
<body>

<header><h1>UScan Pro v25.8 — FINAL CLEAN</h1></header>
<center><button class="top-btn" id="scanBtn">SCAN & EXTRACT</button></center>
<div id="pasteArea" contenteditable="true"></div>
<button id="floatBtn">Right Arrow</button>

<div id="coPilot">
  <div id="coHeader">UScan Co-Pilot</div>
  <div id="chatArea">
    <div class="msg grok">v25.8 loaded. Click SCAN to launch.</div>
  </div>
</div>

<script type="module">
let pyodide = null;

function addMsg(text, type = "grok") {
  const div = document.createElement("div");
  div.className = "msg " + type;
  div.innerHTML = text;
  document.getElementById("chatArea").appendChild(div);
  div.scrollIntoView({behavior: "smooth"});
}

async function initPyodide() {
  if (pyodide) return;
  addMsg("Loading Pyodide + yfinance...", "grok");
  pyodide = await loadPyodide();
  await pyodide.loadPackage(["numpy", "pandas", "micropip"]);
  await pyodide.runPythonAsync(`import micropip; await micropip.install('yfinance')`);
  addMsg("Engine ready.", "grok");
}

document.getElementById("scanBtn").onclick = async () => {
  document.getElementById("coPilot").style.display = "flex";
  document.getElementById("floatBtn").style.display = "block";
  document.getElementById("chatArea").innerHTML = '<div class="msg grok">Launching Monte Carlo...</div>';

  await initPyodide();

  const resp = await fetch("engine.py?" + Date.now()); // cache buster
  if (!resp.ok) {
    addMsg("ERROR: engine.py not found!", "grok");
    return;
  }
  const code = await resp.text();
  addMsg("engine.py loaded. Running 10,000 paths...", "grok");

  try {
    const output = await pyodide.runPythonAsync(code);
    const data = JSON.parse(output);

    addMsg(`
      Expected Return: <b style="color:#00ff88">+${data.er}%</b><br>
      Loss Probability: <b style="color:#ff4444">${data.loss}%</b><br><br>
      <b>STRONG BUY</b>
    `, "result");

    const plotDiv = document.createElement("div");
    plotDiv.style.width = "100%";
    plotDiv.style.height = "480px";
    document.getElementById("chatArea").appendChild(plotDiv);

    const script = document.createElement("script");
    script.src = "https://cdn.plot.ly/plotly-2.34.0.min.js";
    script.onload = () => {
      Plotly.newPlot(plotDiv, [{
        y: data.payoffs,
        type: "histogram",
        marker: {color: "#8b5cf6"}
      }], {
        title: {text: "10,000 Correlated Paths — v25.8", font: {color: "#e0e0ff"}},
        paper_bgcolor: "#0f0f23",
        plot_bgcolor: "#0f0f23",
        font: {color: "#e0e0ff"}
      }, {responsive: true});
    };
    document.head.appendChild(script);

  } catch (e) {
    addMsg("Python error: " + e.message, "grok");
  }
};

document.getElementById("floatBtn").onclick = () => {
  document.getElementById("coPilot").style.display = "flex";
};
</script>
</body>
</html>
