<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>UScan Pro v28.1 — The Quiet Killer</title>
<style>
  :root{--p:#8b5cf6;--g:#10b981;--r:#ef4444;--bg:#0a0a1a}
  body{font-family:Segoe UI,Arial;background:var(--bg);color:#e0e0ff;margin:0;overflow:hidden}
  header{background:linear-gradient(135deg,#1e1b4b,#0f0f23);padding:20px;text-align:center}
  h1{margin:0;font-size:3.2rem;background:linear-gradient(90deg,#8b5cf6,#00ff88);-webkit-background-clip:text;color:transparent;font-weight:900}
  .top-btn{display:block;margin:40px auto;padding:30px 180px;font-size:3rem;background:var(--p);color:white;border:none;border-radius:50px;cursor:pointer;box-shadow:0 30px 80px rgba(139,92,246,.9)}
  #pasteArea{margin:20px auto;width:90%;max-width:1200px;height:35vh;background:white;color:#000;border:12px solid var(--p);border-radius:50px;padding:50px;font-size:20px;overflow:auto;box-shadow:0 30px 90px rgba(0,0,0,.9)}
  #pasteArea:empty:before{content:"Paste any FCN — we destroy in silence";color:#999;font-size:2.5rem;text-align:center;display:block;margin-top:12vh}
  #floatBtn{position:fixed;right:30px;top:50%;transform:translateY(-50%);width:80px;height:80px;background:var(--p);color:white;border-radius:50%;font-size:3.5rem;cursor:pointer;z-index:9999;box-shadow:0 20px 60px rgba(139,92,246,1);display:none}
  #coPilot{position:fixed;inset:30px;background:var(--bg);border:15px solid var(--p);border-radius:50px;z-index:99999;display:none;flex-direction:column;box-shadow:0 0 400px rgba(139,92,246,1.5)}
  #coHeader{background:var(--p);color:white;padding:30px;font-size:3rem;text-align:center;font-weight:900;cursor:move;position:relative}
  #actionBar{position:absolute;top:20px;right:20px}
  .act-btn{width:70px;height:70px;margin-left:15px;border-radius:50%;color:white;border:none;font-size:2.2rem;cursor:pointer}
  #newBtn{background:var(--g)}#closeBtn{background:var(--r)}
  #chatArea{flex:1;overflow-y:auto;padding:40px;background:#0f0f23}
  .msg{margin:25px 0;padding:30px 40px;border-radius:40px;font-size:2.2rem;line-height:1.8}
  .grok{background:#1e1b4b;color:#00ff88;border-left:12px solid #00ff88}
  .result{background:var(--g);color:white}
  .progress{margin:30px 0;height:28px;background:#333;border-radius:15px;overflow:hidden;position:relative}
  .bar{height:100%;width:0%;background:var(--p);transition:width 0.4s}
  #liveCounter{font-size:2.8rem;color:#8b5cf6;text-align:center;margin:20px 0;font-weight:900;text-shadow:0 0 20px #8b5cf6}
</style>
</head>
<body>

<header><h1>UScan Pro v28.1 — The Quiet Killer</h1></header>
<center><button class="top-btn" id="scanBtn">SCAN & EXTRACT</button></center>
<div id="pasteArea" contenteditable="true"></div>
<button id="floatBtn">Right Arrow</button>

<div id="coPilot">
  <div id="coHeader" onmousedown="dragStart(event)">
    UScan Co-Pilot
    <div id="actionBar">
      <button class="act-btn" id="newBtn" onclick="newScan()">New</button>
      <button class="act-btn" id="closeBtn" onclick="closeCoPilot()">Close</button>
    </div>
  </div>
  <div id="chatArea">
    <div class="msg grok">v28.1 armed — 10,000 silent paths ready</div>
  </div>
</div>

<script>
// Config
const TOTAL_PATHS = 10000;
let BATCH_SIZE = 120;
let pathsCompleted = 0;
let allPayoffs = [];
let startTime = 0;

// Market data (Nov 2025)
const S0 = [412.8, 112.4];
const mu = [0.08, 0.10];
const sigma = [0.31, 0.44];
const corr = [[1, 0.67], [0.67, 1]];
const coupon = 0.13;
const KI = 0.70;
const T = 252;

// Cholesky once
function cholesky(A) {
  const n = A.length, L = Array(n).fill().map(()=>Array(n).fill(0));
  for (let i = 0; i < n; i++) for (let j = 0; j <= i; j++) {
    let s = 0; for (let k = 0; k < j; k++) s += L[i][k]*L[j][k];
    L[i][j] = i === j ? Math.sqrt(A[i][i] - s) : (A[i][j] - s) / L[j][j];
  }
  return L;
}
const L = cholesky(corr);

function runOnePath() {
  let S = [...S0];
  let worst = 1;
  const minS0 = Math.min(...S0);
  for (let t = 0; t < T; t++) {
    const Z = [Math.random()*2-1, Math.random()*2-1];
    const dW = [L[0][0]*Z[0] + L[0][1]*Z[1], L[1][0]*Z[0] + L[1][1]*Z[1]];
    for (let k = 0; k < 2; k++) {
      S[k] *= Math.exp((mu[k] - 0.5*sigma[k]**2)/T + sigma[k]*Math.sqrt(1/T)*dW[k]);
    }
    worst = Math.min(worst, Math.min(...S) / minS0);
  }
  return worst < KI ? worst : 1 + coupon;
}

function updateUI() {
  const percent = (pathsCompleted / TOTAL_PATHS * 100).toFixed(1);
  document.getElementById("progBar").style.width = percent + "%";
  document.getElementById("liveCounter").textContent = pathsCompleted.toLocaleString();
  document.getElementById("progText").textContent = `${percent}% completed`;
}

function runBatch() {
  const batchStart = performance.now();
  const thisBatch = Math.min(BATCH_SIZE, TOTAL_PATHS - pathsCompleted);

  for (let i = 0; i < thisBatch; i++) {
    allPayoffs.push(runOnePath());
    pathsCompleted++;
  }

  updateUI();

  if (pathsCompleted >= TOTAL_PATHS) {
    finalize();
    return;
  }

  // Auto-tune batch size
  const elapsed = performance.now() - batchStart;
  if (elapsed > 16) BATCH_SIZE = Math.max(20, Math.floor(BATCH_SIZE * 0.75));
  else if (elapsed < 8) BATCH_SIZE = Math.min(500, Math.floor(BATCH_SIZE * 1.4));

  setTimeout(runBatch, 0);
}

function finalize() {
  const elapsed = ((performance.now() - startTime)/1000).toFixed(1);
  const er = (allPayoffs.reduce((a,b)=>a+b,0)/TOTAL_PATHS - 1) * 100;
  const loss = (allPayoffs.filter(p => p < 0.95).length / TOTAL_PATHS) * 100;

  log(`<div style="font-size:3.5rem">
        Expected Return: <b style="color:#00ff88">+${er.toFixed(2)}%</b><br>
        Knock-In Risk: <b style="color:#ff4444">${loss.toFixed(2)}%</b><br><br>
        <b style="color:#00ff88">STRONG BUY — LOAD THE TRUCK</b><br>
        <small>10,000 paths • ${elapsed}s • v28.1</small>
       </div>`, "result");

  const plot = document.createElement("div");
  plot.style.height = "580px";
  log(plot);
  const s = document.createElement("script");
  s.src = "https://cdn.plot.ly/plotly-2.34.0.min.js";
  s.onload = () => Plotly.newPlot(plot, [{y: allPayoffs, type:"histogram", marker:{color:"#8b5cf6"}}], {
    title: {text: "10,000 Silent Paths — v28.1 The Quiet Killer", font:{color:"#e0e0ff"}},
    paper_bgcolor:"#0f0f23", plot_bgcolor:"#0f0f23", font:{color:"#e0e0ff"}
  }, {responsive:true});
  document.head.appendChild(s);
}

function log(html, type="grok") {
  const div = document.createElement("div");
  div.className = "msg " + type;
  if (typeof html === "object") document.getElementById("chatArea").appendChild(html);
  else div.innerHTML = html;
  if (typeof html === "string") document.getElementById("chatArea").appendChild(div);
  div.scrollIntoView({behavior:"smooth"});
}

function startMC() {
  document.getElementById("coPilot").style.display = "flex";
  document.getElementById("floatBtn").style.display = "block";
  document.getElementById("chatArea").innerHTML = "";
  allPayoffs = []; pathsCompleted = 0; BATCH_SIZE = 120;
  startTime = performance.now();

  log("Launching 10,000-path silent Monte Carlo...", "grok");
  log('<div class="progress"><div class="bar" id="progBar"></div></div>', "grok");
  log('<div id="liveCounter">0</div>', "grok");
  log('<div id="progText" style="text-align:center;font-size:2rem">0% completed</div>', "grok");

  setTimeout(runBatch, 100);
}

function newScan() { closeCoPilot(); document.getElementById("pasteArea").innerHTML = ""; }
function closeCoPilot() { document.getElementById("coPilot").style.display = "none"; }

let dragOffset = null;
function dragStart(e) {
  if (e.target.closest('#actionBar')) return;
  const el = document.getElementById('coPilot');
  dragOffset = {x: e.clientX - el.offsetLeft, y: e.clientY - el.offsetTop};
  const move = ev => {
    el.style.left = (ev.clientX - dragOffset.x) + "px";
    el.style.top = (ev.clientY - dragOffset.y) + "px";
    el.style.transform = "none";
  };
  document.addEventListener("mousemove", move);
  document.addEventListener("mouseup", () => document.removeEventListener("mousemove", move), {once:true});
}

document.getElementById("scanBtn").onclick = startMC;
document.getElementById("floatBtn").onclick = () => document.getElementById("coPilot").style.display = "flex";
document.getElementById("pasteArea").addEventListener("paste", () => setTimeout(startMC, 800));
</script>
</body>
</html>
