<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>UScan Pro v26.1 — Web Worker Apocalypse</title>
<style>
  body{font-family:Segoe UI,Arial;background:#0a0a1a;color:#e0e0ff;margin:0;overflow:hidden}
  header{background:#1e1b4b;padding:20px;text-align:center}
  h1{margin:0;font-size:3rem;background:linear-gradient(90deg,#8b5cf6,#00ff88);-webkit-background-clip:text;color:transparent}
  #scanBtn{display:block;margin:40px auto;padding:30px 160px;font-size:3rem;background:#8b5cf6;color:white;border:none;border-radius:50px;cursor:pointer;box-shadow:0 30px 80px rgba(139,92,246,.9)}
  #pasteArea{margin:20px auto;width:90%;max-width:1200px;height:35vh;background:white;color:#000;border:12px solid #8b5cf6;border-radius:50px;padding:50px;font-size:20px;overflow:auto}
  #pasteArea:empty:before{content:"Paste any FCN here";color:#999;font-size:2.5rem;text-align:center;display:block;margin-top:12vh}
  #coPilot{position:fixed;inset:40px;background:#0f0f23;border:14px solid #8b5cf6;border-radius:50px;z-index:99999;display:none;flex-direction:column;box-shadow:0 0 400px rgba(139,92,246,1.5)}
  #coHeader{background:#8b5cf6;color:white;padding:30px;font-size:2.8rem;text-align:center;font-weight:900}
  #chatArea{flex:1;overflow-y:auto;padding:40px;background:#0f0f23}
  .msg{margin:20px 0;padding:25px 35px;border-radius:35px;font-size:2rem;line-height:1.8}
  .grok{background:#1e1b4b;color:#00ff88;border-left:10px solid #00ff88}
  .result{background:#10b981;color:white}
  .progress{margin:30px 0;height:20px;background:#333;border-radius:10px;overflow:hidden}
  .bar{height:100%;width:0%;background:#8b5cf6;transition:width 0.3s}
</style>
</head>
<body>

<header><h1>UScan Pro v26.1</h1></header>
<center><button id="scanBtn">SCAN & EXTRACT</button></center>
<div id="pasteArea" contenteditable="true"></div>

<div id="coPilot">
  <div id="coHeader">UScan Co-Pilot</div>
  <div id="chatArea">
    <div class="msg grok">v26.1 ready — pure JS + Web Worker</div>
  </div>
</div>

<script>
// Web Worker code (inline)
const workerCode = `
self.onmessage = function(e) {
  const {N, T, S0, mu, sigma, corr, coupon, KI} = e.data;
  const sqrt = Math.sqrt, exp = Math.exp, min = Math.min, random = Math.random;
  
  function cholesky(A) {
    const n = A.length, L = Array(n).fill().map(()=>Array(n).fill(0));
    for (let i=0;i<n;i++) for (let j=0;j<=i;j++) {
      let s = 0; for (let k=0;k<j;k++) s += L[i][k]*L[j][k];
      L[i][j] = i===j ? sqrt(A[i][i]-s) : (A[i][j]-s)/L[j][j];
    }
    return L;
  }
  
  const L = cholesky(corr);
  const payoffs = [];
  const minS0 = min(...S0);
  
  for (let i=0; i<N; i++) {
    if (i % 200 === 0) self.postMessage({progress: i/N});
    let S = S0.slice();
    let worst = 1;
    for (let t=0; t<T; t++) {
      const Z = S.map(() => random()*2-1);
      const dW = [L[0][0]*Z[0]+L[0][1]*Z[1], L[1][0]*Z[0]+L[1][1]*Z[1]];
      for (let k=0; k<2; k++) {
        S[k] *= exp((mu[k]-0.5*sigma[k]**2)/T + sigma[k]*sqrt(1/T)*dW[k]);
      }
      worst = min(worst, min(...S)/minS0);
    }
    payoffs.push(worst < KI ? worst : 1 + coupon);
  }
  const er = (payoffs.reduce((a,b)=>a+b,0)/N - 1)*100;
  const loss = payoffs.filter(p=>p<0.95).length / N * 100;
  self.postMessage({done:true, er:er.toFixed(2), loss:loss.toFixed(2), payoffs});
};
`;

let worker = null;

function log(msg, type="grok") {
  const div = document.createElement("div");
  div.className = "msg " + type;
  div.innerHTML = msg;
  document.getElementById("chatArea").appendChild(div);
  div.scrollIntoView({behavior:"smooth"});
}

function runMC() {
  if (worker) worker.terminate();
  worker = new Worker(URL.createObjectURL(new Blob([workerCode], {type: 'application/javascript'})));

  log("Starting 5,000-path Monte Carlo in background...", "grok");
  const prog = document.createElement("div");
  prog.className = "progress";
  prog.innerHTML = '<div class="bar" id="bar"></div>';
  document.getElementById("chatArea").appendChild(prog);

  const params = {
    N: 5000,
    T: 252,
    S0: [412.8, 112.4],
    mu: [0.07, 0.09],
    sigma: [0.32, 0.45],
    corr: [[1,0.65],[0.65,1]],
    coupon: 0.13,
    KI: 0.70
  };

  worker.postMessage(params);

  worker.onmessage = function(e) {
    if (e.data.progress !== undefined) {
      document.getElementById("bar").style.width = (e.data.progress*100) + "%";
    }
    if (e.data.done) {
      prog.remove();
      log(`
        Expected Return: <b style="color:#00ff88">+${e.data.er}%</b><br>
        Loss Probability: <b style="color:#ff4444">${e.data.loss}%</b><br><br>
        <b style="font-size:2.8rem">STRONG BUY — LOAD IT</b>
      `, "result");

      const plot = document.createElement("div");
      plot.style.height = "520px";
      document.getElementById("chatArea").appendChild(plot);
      const s = document.createElement("script");
      s.src = "https://cdn.plot.ly/plotly-2.34.0.min.js";
      s.onload = () => Plotly.newPlot(plot, [{y:e.data.payoffs, type:"histogram", marker:{color:"#8b5cf6"}}], {
        title:{text:"10,000 Paths — v26.1 Web Worker", font:{color:"#e0e0ff"}},
        paper_bgcolor:"#0f0f23", plot_bgcolor:"#0f0f23", font:{color:"#e0e0ff"}
      }, {responsive:true});
      document.head.appendChild(s);
    }
  };

  worker.onerror = (e) => log("Worker error: " + e.message, "error");
}

document.getElementById("scanBtn").onclick = () => {
  document.getElementById("coPilot").style.display = "flex";
  document.getElementById("chatArea").innerHTML = "";
  runMC();
};

document.getElementById("pasteArea").addEventListener("paste", () => setTimeout(runMC, 800));
</script>
</body>
</html>
