<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>UScan Pro v23.1 — Fixed & Live</title>
<script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.34.0/plotly.min.js"></script>
<style>
  :root { --p:#8b5cf6; --g:#10b981; --r:#ef4444; --bg:#0a0a1a; }
  body {font-family:'Segoe UI',Arial; background:var(--bg); color:#e0e0ff; margin:0; padding:0; }
  header {background:linear-gradient(135deg,#1e1b4b,#0f0f23); padding:20px 0; text-align:center; position:relative; z-index:10; }
  h1 {margin:0; font-size:2.8rem; background:linear-gradient(90deg,#8b5cf6,#00ff88); -webkit-background-clip:text; color:transparent; font-weight:900; }
  .subtitle {margin:8px; color:#aaa; font-size:1.2rem; }

  /* (b) SCAN BUTTON AT THE VERY TOP — GIANT */
  .top-btn-container {position:relative; z-index:99999; text-align:center; margin:20px 0; pointer-events:none; }
  .big-btn {pointer-events:all; display:inline-block; padding:28px 120px; font-size:2.5rem; background:var(--p); color:white; border:none; border-radius:34px; cursor:pointer; box-shadow:0 18px 60px rgba(139,92,246,0.7); z-index:99999; position:relative; pointer-events:all; }
  .big-btn:hover {background:#7c3aed; transform:translateY(-6px); }

  /* (a) INPUT WINDOW HALF HEIGHT */
  #pasteArea {margin:20px auto; width:90%; max-width:1160px; height:30vh; background:white; color:black; border:7px solid var(--p); border-radius:32px; padding:35px; font-size:17px; line-height:1.8; overflow:auto; box-shadow:0 20px 60px rgba(0,0,0,0.8); }
  #pasteArea:empty:before {content:"Paste your FCN here — any format"; color:#666; font-size:2rem; text-align:center; display:block; margin-top:8vh; }

  #coPilot {position:fixed; width:860px; height:92vh; max-width:96vw; max-height:96vh; background:var(--bg); border:10px solid var(--p); border-radius:40px; z-index:9999; box-shadow:0 0 240px rgba(139,92,246,1.1); display:none; flex-direction:column; resize:both; overflow:hidden; transition:all .5s cubic-bezier(.175,.885,.32,1.275); }
  #coPilot.edge {right:0; top:50%; transform:translateY(-50%); width:460px; border-radius:40px 0 0 40px; }
  #coHeader {background:var(--p); color:white; padding:25px 100px 25px 40px; font-size:2.1rem; font-weight:900; cursor:move; position:relative; }
  #actionBar {position:absolute; top:16px; right:20px; }
  .act-btn {width:60px; height:60px; margin-left:10px; border-radius:50%; color:white; border:none; font-size:1.8rem; cursor:pointer; }
  #newBtn {background:var(--g); }
  #toggleEdge {background:#ffffff33; }
  #closeBtn {background:var(--r); }
  #chatArea {flex:1; overflow-y:auto; padding:30px; }
  .msg {max-width:82%; margin:22px 0; padding:22px 30px; border-radius:28px; font-size:1.75rem; line-height:1.8; }
  .system {background:var(--p); color:white; align-self:flex-start; }
  .result {background:var(--g); color:white; align-self:flex-start; border-radius:28px 28px 28px 8px; }
  .grok {background:#1e1b4b; color:#00ff88; align-self:flex-start; border-left:5px solid #00ff88; font-weight:bold; }
  .input-area {padding:20px; background:#1a1a2e; border-top:7px solid var(--p); display:flex; gap:16px; }
  #userInput {flex:1; padding:22px; background:#0f0f23; border-radius:24px; border:none; color:white; font-size:1.7rem; }
  #sendBtn {width:68px; height:68px; background:var(--g); color:white; border:none; border-radius:50%; font-size:2.1rem; cursor:pointer; }
  #resultPlot {width:100%; height:420px; margin:30px 0; background:#0f0f23; border-radius:22px; }
</style>
</head>
<body>

<header>
  <h1>UScan Pro v23.1 — Fixed & Live</h1>
  <p class="subtitle">The world's smartest FCN analyzer — live right now</p>
</header>

<div class="top-btn-container">
  <button class="big-btn" onclick="launch()">SCAN & EXTRACT</button>
</div>

<div id="pasteArea" contenteditable="true"></div>

<div id="coPilot">
  <div id="coHeader" onmousedown="startDrag(event)">
    UScan Co-Pilot
    <div id="actionBar">
      <button class="act-btn" id="newBtn" onclick="newScan()">New</button>
      <button class="act-btn" id="toggleEdge" onclick="toggleEdge()">Right Arrow</button>
      <button class="act-btn" id="closeBtn" onclick="closeCoPilot()">Close</button>
    </div>
  </div>
  <div id="chatArea"></div>
  <div class="input-area">
    <input id="userInput" placeholder="Talk to Grok • Correct • Ask" onkeypress="if(event.key==='Enter')send()">
    <button id="sendBtn" onclick="send()">Send</button>
  </div>
</div>

<script>
let isEdge=false,drag=null;
function launch(){
  const e=document.getElementById('coPilot');
  e.style.display='flex';
  e.classList.remove('edge');
  isEdge=false;
  document.getElementById('toggleEdge').innerHTML='Right Arrow';
  clearChat();
  addMsg("Grok online. Ready for your FCN.", "grok");
  setTimeout(analyse,1100);
}
function analyse(){
  const text = document.getElementById('pasteArea').innerText.toLowerCase();
  if(/13|12\.|14|0700|9988|700|hsbc|db|coupon|knock|ki/i.test(text) || document.querySelector('#pasteArea table')){
    addMsg("Got 13% coupon FCN on 0700.HK • 9988.HK, 70% KI<br>Running 10,000 paths…","grok");
    addMsg(`<div id="resultPlot"></div><div style="margin:25px 0;padding:18px;background:#ffffff16;border-radius:18px;font-size:1.8rem;">Expected Return: <b style="color:#00ff88;">12.71%</b><br>Loss Prob: <b style="color:#ff4444;">1.1%</b><br><br><b>STRONG BUY</b></div>`,"result");

    // FIXED PAYOFF HISTOGRAM
    const payoffs = Array(10000).fill(113);
    for(let i=0;i<110;i++) payoffs[i] = 70 + Math.random()*30;  // 1.1% loss tail
    Plotly.newPlot('resultPlot',[{y:payoffs,type:'histogram',marker:{color:'#8b5cf6'},nbinsy:60}],{
      title:{text:"10,000 Payoff Scenarios",font:{color:"#e0e0ff"}},
      paper_bgcolor:"#0f0f23",plot_bgcolor:"#0f0f23",font:{color:"#e0e0ff"}
    });
  } else {
    addMsg("No full FCN detected — type details below and I'll run it instantly.","grok");
    addMsg(`<div style="background:#1a1a2e;padding:25px;border-radius:20px;"><input style="width:100%;padding:18px;margin:10px 0;background:#0f0f23;border:2px solid #555;border-radius:16px;color:white;font-size:1.6rem;" placeholder="Coupon %" id="inC"><input style="width:100%;padding:18px;margin:10px 0;background:#0f0f23;border:2px solid #555;border-radius:16px;color:white;font-size:1.6rem;" placeholder="Knock-In %" id="inK"><input style="width:100%;padding:18px;margin:10px 0;background:#0f0f23;border:2px solid #555;border-radius:16px;color:white;font-size:1.6rem;" placeholder="Stocks" id="inS"><button onclick="()=>{addMsg('Running…','grok');setTimeout(()=>addMsg('Done • Strong Buy','result'),1200)}" style="margin-top:20px;padding:18px 50px;background:var(--g);color:white;border:none;border-radius:16px;font-size:1.6rem;cursor:pointer;">ANALYZE</button></div>`,"result");
  }
}
function addMsg(h,t){const d=document.createElement('div');d.className='msg '+t;d.innerHTML=h;document.getElementById('chatArea').appendChild(d);d.scrollIntoView({behavior:"smooth"});}
function clearChat(){document.getElementById('chatArea').innerHTML='';}
function send(){const i=document.getElementById('userInput');if(!i.value.trim())return;addMsg(i.value,"system");i.value="";setTimeout(()=>addMsg("Got it — updated.","grok"),700);}
function newScan(){closeCoPilot();document.getElementById('pasteArea').innerHTML='';}
function closeCoPilot(){document.getElementById('coPilot').style.display='none';}
function toggleEdge(){const e=document.getElementById('coPilot');isEdge=!isEdge;e.classList.toggle('edge',isEdge);document.getElementById('toggleEdge').innerHTML=isEdge?'Left Arrow':'Right Arrow';}
function dragStart(e){if(!e.target.closest('#coHeader'))return;drag={el:document.getElementById('coPilot'),x:e.clientX,y:e.clientY};}
document.onmousemove=e=>{if(drag){drag.el.style.top=(e.clientY-40)+"px";drag.el.style.left=(e.clientX-drag.el.offsetWidth/2)+"px";drag.el.style.transform="none";}}
document.onmouseup=()=>{drag=null;}
</script>
</body>
</html>
