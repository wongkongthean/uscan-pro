<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>UScan Pro v30.4-AI-ALPHA</title>
<style>
  :root{--p:#8b5cf6;--g:#10b981;--y:#fbbf24;--r:#ef4444;--bg:#000}
  body{font-family:Arial,Helvetica,sans-serif;background:#000;color:#ccc;margin:0;overflow:hidden;font-size:14px;line-height:1.4}
  header{background:#111;padding:12px 20px;text-align:center;border-bottom:2px solid var(--p);position:relative}
  h1{margin:0;font-size:22px;color:#fff;font-weight:normal}
  .alpha-badge{position:absolute;top:10px;right:15px;background:#000;border:2px solid var(--p);padding:5px 12px;font-size:11px;letter-spacing:1.5px;font-weight:bold;color:var(--p)}
  .top-btn{margin:20px auto;padding:14px 40px;font-size:16px;background:var(--p);color:#fff;border:none;border-radius:6px;cursor:pointer;display:block}
  #pasteArea{margin:20px auto;width:94%;height:42vh;background:#111;color:#fff;border:2px solid #333;padding:16px;font-size:13px;overflow:auto;border-radius:6px}
  #pasteArea:empty:before{content:"Paste Fixed Coupon Note(s)...";color:#555;font-style:italic}
  #floatBtn,#arrowBtn{position:fixed;width:56px;height:56px;background:var(--p);color:#fff;border-radius:50%;font-size:28px;border:none;cursor:pointer;z-index:9999;box-shadow:0 4px 20px rgba(139,92,246,.8)}
  #floatBtn{right:20px;bottom:20px}
  #arrowBtn{right:20px;top:50%;transform:translateY(-50%)}
  #coPilot{position:fixed;inset:30px;background:#000;border:3px solid var(--p);border-radius:8px;z-index:99999;display:none;flex-direction:column;box-shadow:0 0 30px rgba(139,92,246,.5);resize:both;overflow:hidden}
  #coHeader{background:var(--p);color:#fff;padding:10px;font-size:16px;text-align:center;cursor:move;font-weight:bold}
  #chatArea{flex:1;overflow-y:auto;padding:16px;background:#111;font-size:13px}
  .msg{margin:12px 0;padding:12px 16px;border-radius:6px}
  .grok{background:#1a1a2e;color:#0f0}
  .result{background:#1a1a2e;color:#ddd;border-left:3px solid var(--y)}
  .disclaimer{background:#330000;color:#ff6b6b;padding:12px;border-radius:6px;margin:16px 0;font-size:12px;text-align:center}
  #confirmBox{position:fixed;inset:0;background:#000d;display:none;flex-direction:column;justify-content:center;align-items:center;z-index:999999}
  #confirmInner{background:#111;padding:30px;border-radius:8px;border:3px solid var(--p);width:740px;max-height:85vh;overflow-y:auto;color:#ddd}
  .btn{padding:10px 24px;margin:8px;font-size:14px;border:none;border-radius:6px;cursor:pointer}
  .yes{background:var(--g);color:#fff}
  .no{background:#444;color:#fff}
  .note-block{background:#1a1a2e;padding:14px;margin:12px 0;border-radius:6px;border-left:4px solid var(--p)}
</style>
</head>
<body>

<header>
  <h1>UScan Pro <span style="color:#888">v30.4-AI-ALPHA</span></h1>
  <div class="alpha-badge">AI-ALPHA</div>
</header>

<center><button class="top-btn" id="scanBtn">ANALYZE NOTES</button></center>
<div id="pasteArea" contenteditable="true"></div>

<button id="floatBtn" onclick="toggleCoPilot()">Arrow Right</button>
<button id="arrowBtn" onclick="toggleCoPilot()">Arrow Right</button>

<div id="coPilot">
  <div id="coHeader" onmousedown="dragStart(event)">UScan Co-Pilot v30.4-AI-ALPHA</div>
  <div id="chatArea">
    <div class="grok">AI-ALPHA engine online. Mandatory confirmation active.</div>
    <div class="disclaimer">
      EDUCATIONAL & RESEARCH TOOL ONLY • NOT INVESTMENT ADVICE • FOR STUDY PURPOSES ONLY
    </div>
  </div>
</div>

<div id="confirmBox">
  <div id="confirmInner" onmousedown="dragConfirm(event)">
    <h3 style="color:var(--p);margin-top:0">Confirm Analysis Request</h3>
    <p>User confirmation required before processing:</p>
    <div id="confirmList"></div>
    <div style="text-align:center;margin-top:20px">
      <button class="btn yes" onclick="proceed()">Confirm & Run Analysis</button>
      <button class="btn no" onclick="cancel()">Cancel</button>
    </div>
  </div>
</div>

<script>
let parsedNotes = [];

function toggleCoPilot(){
  const cp = document.getElementById("coPilot");
  cp.style.display = cp.style.display === "flex" ? "none" : "flex";
}

function rateROI(roi){
  if(roi >= 15) return {text:"Excellent", color:"#0f0"};
  if(roi >= 10) return {text:"Very Attractive", color:"#0f0"};
  if(roi >= 5)  return {text:"Attractive", color:"#8f8"};
  if(roi >= 0)  return {text:"Neutral", color:"#ff8"};
  if(roi >= -10) return {text:"Elevated Risk", color:"#f80"};
  return {text:"Highly Speculative", color:"#f00"};
}

function parseFCNs(text){
  const blocks = text.trim().split(/\n\s*\n/).map(b=>b.trim()).filter(b=>b);
  const notes = [];
  for(let block of blocks){
    const lines = block.toLowerCase().split('\n');
    const n = {underlyings:[], tenor:0, strike:null, ki:null, ko:null, coupon:null, issuer:null};
    for(let l of lines){
      if(/tencent|700/.test(l)) n.underlyings.push('0700.HK');
      if(/baba|9988/.test(l)) n.underlyings.push('9988.HK');
      if(/byd|1211/.test(l)) n.underlyings.push('1211.HK');
      if(/geely|175/.test(l)) n.underlyings.push('0175.HK');
      if(/month/.test(l)) n.tenor = parseInt(l.match(/\d+/)||[0]);
      if(/strike/.test(l)) n.strike = parseFloat(l.match(/\d+\.?\d*/)[0])/100;
      if(/ki /.test(l)) n.ki = parseFloat(l.match(/\d+\.?\d*/)[0])/100;
      if(/ko /.test(l)) n.ko = parseFloat(l.match(/\d+\.?\d*/)[0])/100;
      if(/coupon/.test(l)) n.coupon = parseFloat(l.match(/\d+\.?\d*/)[0])/100;
      if(/issuer/.test(l)) n.issuer = (l.split(' ').pop()||'').toUpperCase();
    }
    if(n.underlyings.length && n.coupon && n.tenor) notes.push(n);
  }
  return notes;
}

function analyze(){
  const text = document.getElementById("pasteArea").innerText.trim();
  if(text.length < 40) return;
  parsedNotes = parseFCNs(text);
  if(parsedNotes.length === 0) {
    log("No valid FCN detected.", "grok");
    return;
  }
  showConfirmation();
}

function showConfirmation(){
  const list = document.getElementById("confirmList");
  list.innerHTML = "";
  parsedNotes.forEach((n,i)=>{
    const roi = n.coupon * (n.tenor/12) * 100;
    const rating = rateROI(roi);
    list.innerHTML += `
      <div class="note-block">
        <b>Note ${i+1}</b>: ${n.underlyings.join(' + ')}<br>
        ${n.tenor} months | ${(n.coupon*100).toFixed(1)}% p.a. → <span style="color:${rating.color}">${roi.toFixed(2)}% annualized</span><br>
        Strike ${n.strike?(n.strike*100).toFixed(1)+'%':'—'} | KI ${n.ki?(n.ki*100).toFixed(0)+'%':'—'} | KO ${n.ko?(n.ko*100).toFixed(0)+'%':'—'} | Issuer ${n.issuer||'—'}
      </div>`;
  });
  document.getElementById("confirmBox").style.display = "flex";
}

function proceed(){
  document.getElementById("confirmBox").style.display = "none";
  toggleCoPilot();
  document.getElementById("chatArea").innerHTML = "";
  log("Analysis authorized by user.","grok");
  parsedNotes.forEach((n,i)=>{
    const roi = n.coupon * (n.tenor/12) * 100;
    const rating = rateROI(roi);
    log(`
      <div class="result">
        <b>Note ${i+1}</b> — ${n.underlyings.join(' + ')}<br>
        ${n.tenor} months | ${(n.coupon*100).toFixed(1)}% p.a. coupon<br>
        <b style="color:${rating.color}">Yield ${roi.toFixed(2)}% p.a. → ${rating.text}</b>
      </div>
    `);
  });
}

function cancel(){
  document.getElementById("confirmBox").style.display = "none";
  log("Analysis cancelled by user.","grok");
}

function log(html,type="grok"){
  const d=document.createElement("div"); d.className="msg "+type;
  d.innerHTML=html; document.getElementById("chatArea").appendChild(d);
  d.scrollIntoView();
}

// Drag for Co-Pilot
function dragStart(e){
  if(e.target.tagName==="BUTTON") return;
  const el=document.getElementById('coPilot');
  const offset={x:e.clientX-el.offsetLeft,y:e.clientY-el.offsetTop};
  const move=ev=>{el.style.left=(ev.clientX-offset.x)+"px";el.style.top=(ev.clientY-offset.y)+"px";el.style.transform="none";};
  document.addEventListener("mousemove",move);
  document.addEventListener("mouseup",()=>document.removeEventListener("mousemove",move),{once:true});
}
document.getElementById("coHeader").onmousedown=dragStart;

// Drag for confirmation box
function dragConfirm(e){
  const el=document.getElementById('confirmInner');
  const offset={x:e.clientX-el.offsetLeft,y:e.clientY-el.offsetTop};
  const move=ev=>{el.style.left=(ev.clientX-offset.x)+"px";el.style.top=(ev.clientY-offset.y)+"px";};
  document.addEventListener("mousemove",move);
  document.addEventListener("mouseup",()=>document.removeEventListener("mousemove",move),{once:true});
}

document.getElementById("scanBtn").onclick=analyze;
document.getElementById("pasteArea").addEventListener("paste",()=>setTimeout(analyze,800));
</script>
</body>
</html>
